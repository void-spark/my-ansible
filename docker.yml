# Invocation: ansible-playbook -i hosts.docker docker.yml
- name: Setup docker
  hosts: raspberrypi.fritz.box

  roles:
    - docker_base
    - portainer
    - letsencrypt
    - mosquitto

  tasks:
  - name: Make local copy of latest backups
    synchronize:
      mode: pull
      src: rsync://raspberrypi.fritz.box/docker/backups/pi/
      dest: backups
    delegate_to: localhost

  - name: "Restore The Lounge backup"
    unarchive:
      src: "backups/thelounge.tar.gz"
      creates: "/var/docker/data/thelounge"
      dest: "/var/docker/data"

  - name: "Copy The Lounge compose project"
    copy:
      src: thelounge
      dest: /var/docker/compose

  - name: "Pull The Lounge image"
    docker_image:
      name: thelounge/thelounge
      source: pull

  - name: "Create and start The Lounge service"
    docker_compose:
      project_src: /var/docker/compose/thelounge

  - name: "Restore Node-RED backup"
    unarchive:
      src: "backups/nodered.tar.gz"
      creates: "/var/docker/data/nodered"
      dest: "/var/docker/data"

  - name: "Copy Node-RED compose project"
    copy:
      src: nodered
      dest: /var/docker/compose

  - name: "Pull Node-RED image"
    docker_image:
      name: nodered/node-red
      source: pull

  - name: "Create and start Node-RED service"
    docker_compose:
      build: yes
      project_src: /var/docker/compose/nodered
