# Invocation: ansible-playbook -i hosts k8s.yml --check

- name: Setup k8s
  hosts: k8s_all

  tasks:
  - name: Install Docker
    apt:
      name: docker.io
      state: present
      update_cache: true

  - name: Install APT Transport HTTPS
    apt:
      name: apt-transport-https
      state: present

  - name: Install GnuPG
    apt:
      name: gnupg
      state: present

  - name: add Kubernetes apt-key
    apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      state: present

  - name: add Kubernetes' APT repository
    apt_repository:
      repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
      state: present
      filename: 'kubernetes'

  - name: install kubelet
    apt:
      name: kubelet
      state: present
      update_cache: true
  - name: pin kubelet version
    dpkg_selections:
      name: kubelet
      selection: hold

  - name: install kubeadm
    apt:
      name: kubeadm
      state: present
  - name: pin kubeadm version
    dpkg_selections:
      name: kubeadm
      selection: hold

- name: Setup k8s
  hosts: k8s_masters

  tasks:
  - name: install kubectl
    apt:
      name: kubectl
      state: present
  - name: pin kubectl version
    dpkg_selections:
      name: kubectl
      selection: hold
